name: Tests
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Build, run API, and test
        run: |
          # Start the API (corrected path)
          dotnet run --project ./Guber.CoordinatesApi/Guber.CoordinatesApi.csproj --urls "http://localhost:5157" &
          API_PID=$!

          # Wait for the API to become available
          echo "Waiting for API to start..."
          for i in {1..30}; do
            if curl -s http://localhost:5157/health > /dev/null; then
              echo "API is up!"
              break
            fi
            echo "Still waiting... ($i)"
            sleep 2
          done

          # Extra safeguard: ensure process is still alive
          if ! kill -0 $API_PID 2>/dev/null; then
            echo "API process crashed before tests!"
            exit 1
          fi

          # Run the tests
          dotnet test ./Tests/CoordinatesApi.Tests/CoordinatesApi.Tests.csproj --configuration Release

          # Kill the API after tests complete
          kill $API_PID
